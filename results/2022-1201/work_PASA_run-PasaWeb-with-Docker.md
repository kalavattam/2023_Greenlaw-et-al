
`#work_PASA_run-PasaWeb-with-Docker.md`
<br />
<br />

<details>
<summary><b><font size="+2"><i>Table of contents</i></font></b></summary>
<!-- MarkdownTOC -->

1. [On calling `PASA` with `Docker`](#on-calling-pasa-with-docker)
	1. [Follow on and build on examples](#follow-on-and-build-on-examples)
		1. [To address the warning messages...](#to-address-the-warning-messages)
1. [On running `PasaWeb` via `Docker`](#on-running-pasaweb-via-docker)
	1. [To resolve the error try installing `lighttpd` into `Trinity_env`](#to-resolve-the-error-try-installing-lighttpd-into-trinity_env)
		1. [Try things again after having installed `lighttpd`](#try-things-again-after-having-installed-lighttpd)
		1. [Perform troubleshooting](#perform-troubleshooting)
			1. [Using a web browser such as `Chrome`, go to `http://localhost:9000/`](#using-a-web-browser-such-as-chrome-go-to-httplocalhost9000)
			1. [Unable to connect it to the `sqlite` database, so try changing the mounting](#unable-to-connect-it-to-the-sqlite-database-so-try-changing-the-mounting)
		1. [Change directories to check another `sqlite` database](#change-directories-to-check-another-sqlite-database)

<!-- /MarkdownTOC -->
</details>
<br />

<a id="on-calling-pasa-with-docker"></a>
## On calling `PASA` with `Docker`
<a id="follow-on-and-build-on-examples"></a>
### Follow on and build on examples
e.g., the examples included in the [`PASApipeline` `GitHub` repo documentation](https://github.com/PASApipeline/PASApipeline/wiki/PASA_Docker)

```bash
#!/bin/bash
#DONTRUN

transcriptome && \
	cd "results/2022-1201/trinity_5781-5782_Q_IP_merged.trim-rcor.multi-hit-mode_10_EndToEnd"

docker run \
	--rm -it \
	-v "/tmp":"/tmp" \
	-v "$(pwd)":"/$(basename "$(pwd)")" \
	pasapipeline/pasapipeline:latest \
		/usr/local/src/PASApipeline/Launch_PASA_pipeline.pl -h
```

<details>
<summary><i>Click to view: Warning and help messages printed to terminal</i></summary>

```txt
❯ docker run \
>     --rm -it \
>     -v "/tmp":"/tmp" \
>     -v "$(pwd)":"/$(basename "$(pwd)")" \
>     pasapipeline/pasapipeline:latest \
>         /usr/local/src/PASApipeline/Launch_PASA_pipeline.pl -h
WARNING: The requested image's platform (linux/amd64) does not match the detected host platform (linux/arm64/v8) and no specific platform was requested

############################# Options ###############################
#
#   * indicates required
#
#
# --config|-c * <filename>  alignment assembly configuration file
#
# // spliced alignment settings
# --ALIGNERS <string>   aligners (available options include: gmap, blat, minimap2... can run using several, ie. 'gmap,blat,minimap2')
# -N <int>              max number of top scoring alignments (default: 1)
# --MAX_INTRON_LENGTH|-I  <int>         (max intron length parameter passed to GMAP or BLAT)  (default: 100000)
# --IMPORT_CUSTOM_ALIGNMENTS_GFF3 <filename> :only using the alignments supplied in the corresponding GFF3 file.
# --trans_gtf <filename>      :incorporate cufflinks or stringtie--generated transcripts
#
#
# // actions
# --create|-C               flag, create database
# --replace|-r               flag, drop database if -C is also given. This will DELETE all your data and it is irreversible.
# --run|-R               flag, run alignment/assembly pipeline.
# --annot_compare|-A               (see section below; can use with opts -L and --annots)  compare to annotated genes.
# --ALT_SPLICE     flag, run alternative splicing analysis

# // input files
# --genome|-g * <filename>  genome sequence FASTA file (should contain annot db asmbl_id as header accession.)
# --transcripts|-t * <filename>  transcript db
# -f <filename>    file containing a list of fl-cdna accessions.
# --TDN <filename> file containing a list of accessions corresponding to Trinity (full) de novo assemblies (not genome-guided)
#
# // polyAdenylation site identification  ** highly recommended **
# -T               flag,transcript db were trimmed using the TGI seqclean tool.
#    -u <filename>   value, transcript db containing untrimmed sequences (input to seqclean)
#                  <a filename with a .cln extension should also exist, generated by seqclean.>
#
#
#
# Misc:
# --TRANSDECODER   flag, run transdecoder to identify candidate full-length coding transcripts
# --CPU <int>      multithreading (default: 2)
# --PASACONF <string> path to a user-defined pasa.conf file containing mysql connection info
#                      (used in place of the $PASAHOME/pasa_conf/conf.txt file)
#                      (and allows for users to have their own unique mysql connection info)
#                      (instead of the pasa role account)
#
# -d               flag, Debug
# -h               flag, print this option menu and quit
#
#########
#
# // Transcript alignment clustering options (clusters are fed into the PASA assembler):
#
#       By default, clusters together transcripts based on any overlap (even 1 base!).
#
#    Alternatives:
#
#        --stringent_alignment_overlap <float>  (suggested: 30.0)  overlapping transcripts must have this min % overlap to be clustered.
#
#        --gene_overlap <float>  (suggested: 50.0)  transcripts overlapping existing gene annotations are clustered.  Intergenic alignments are clustered by default mechanism.
#               * if --gene_overlap, must also specify --annots  with annotations in recognizable format (gtf, gff3, or data adapted) (just examines 'gene' rows, though).
#
#
#
# --INVALIDATE_SINGLE_EXON_ESTS    :invalidates single exon ests so that none can be built into pasa assemblies.
#
#
# --transcribed_is_aligned_orient   flag for strand-specific RNA-Seq assemblies, the aligned orientation should correspond to the transcribed orientation.
#
#
################
#
#  // Annotation comparison options (used in conjunction with -A at top).
#
#  -L   load annotations (use in conjunction with --annots)
#  --annots <filename>  existing gene annotations in recognized format (gtf, gff3, or custom adapted).
#  --GENETIC_CODE (default: universal, options: Euplotes, Tetrahymena, Candida, Acetabularia)
#
###################### Process Args and Options #####################
```
</details>
<br />

<a id="to-address-the-warning-messages"></a>
#### To address the warning messages...
followed the tact [here](https://stackoverflow.com/questions/66662820/m1-docker-preview-and-keycloak-images-platform-linux-amd64-does-not-match-th)
```bash
#!/bin/bash
#DONTRUN

docker run \
	--rm -it \
	--platform linux/amd64 \
	-v "/tmp":"/tmp" \
	-v "$(pwd)":"/$(basename "$(pwd)")" \
	pasapipeline/pasapipeline:latest \
		/usr/local/src/PASApipeline/Launch_PASA_pipeline.pl -h
```
The warning message is now gone
<br />
<br />

<a id="on-running-pasaweb-via-docker"></a>
## On running `PasaWeb` via `Docker`
```bash
#!/bin/bash
#DONTRUN #CONTINUE

pwd
# /Users/kalavatt/projects-etc/2022_transcriptome-construction/results/2022-1201/trinity_5781-5782_Q_IP_merged.trim-rcor.multi-hit-mode_10_EndToEnd

docker run \
	--rm -it \
	--platform linux/amd64 \
    -v "/tmp":"/tmp" \
    -v "$(pwd)":"/$(basename "$(pwd)")" \
	-p "9000":"9000" \
  	pasapipeline/pasapipeline:latest \
  		/usr/local/src/PASApipeline/run_PasaWeb.pl 9000
```

<details>
<summary><i>Click to view: Error message printed to terminal</i></summary>

```txt
❯ docker run \
>     --rm -it \
>     --platform linux/amd64 \
>     -v "/tmp":"/tmp" \
>     -v "$(pwd)":"/$(basename "$(pwd)")" \
>     -p "9000":"9000" \
>     pasapipeline/pasapipeline:latest \
>         /usr/local/src/PASApipeline/run_PasaWeb.pl 9000
Error, cannot locate 'lighttpd' program. Be sure to have it installed and accessible from your PATH env var at /usr/local/src/PASApipeline/run_PasaWeb.pl line 29.
```
</details>
<br />

<a id="to-resolve-the-error-try-installing-lighttpd-into-trinity_env"></a>
### To resolve the error try installing `lighttpd` into `Trinity_env`
```bash
#!/bin/bash
#DONTRUN #CONTINUE

Trinity_env
# mamba install -c conda-forge lighttpd  # Doesn't work
brew install lighttpd
```

<details>
<summary><i>Click to view: lighttpd installation messages printed to terminal</i></summary>

```txt
❯ brew install lighttpd
Running `brew update --auto-update`...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==> New Formulae
ansible@6                  cargo-deny                 cpuid                      fgbio                      httm                       kubent                     metals                     osv-scanner                retdec                     snakefmt                   steampipe                  txt2man
aribb24                    clitest                    dotnet@6                   gf                         ibazel                     lemmeknow                  mimirtool                  pdf-diff                   ruby@3.1                   sniffnet                   stepci                     video-compare
bossa                      cloudflare-wrangler2       dufs                       ghc@9.2                    jbang                      libfyaml                   mpfrcx                     php@8.1                    sapling                    souffle                    stuffbin                   wikibase-cli
brpc                       clusterawsadm              emqx                       go-task                    jreleaser                  libisofs                   naga-cli                   portablegl                 secp256k1                  spectral-cli               stylelint                  zf
buf                        cocogitto                  envd                       gobackup                   jscpd                      licensed                   nap                        protolint                  seven-kingdoms             speedbump                  syft
busted                     code-cli                   erigon                     grammarly-languageserver   keploy                     luacheck                   nemu                       prowler                    skaffold@1.39              sql-language-server        syslog-ng
cargo-about                cog                        evtx                       hermit                     kubefirst                  marksman                   oauth2c                    psysh                      skeema                     standard                   tproxy

You have 29 outdated formulae installed.
You can upgrade them with brew upgrade
or list them with brew outdated.

==> Fetching dependencies for lighttpd: openssl@1.1, openldap and pcre2
==> Fetching openssl@1.1
==> Downloading https://ghcr.io/v2/homebrew/core/openssl/1.1/manifests/1.1.1s
######################################################################## 100.0%
==> Downloading https://ghcr.io/v2/homebrew/core/openssl/1.1/blobs/sha256:3a7812321f40490623859b1c31644c6f3ba1b76c1ca7f780b9413b912e1b1415
==> Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sha256:3a7812321f40490623859b1c31644c6f3ba1b76c1ca7f780b9413b912e1b1415?se=2023-01-07T00%3A05%3A00Z&sig=35h01fhJ9Sl72K4rcQ5thkBKS0mk2JtWpCu6%2BxESRzk%3D&sp=r&spr=https&sr=b&sv=2019-12-12
######################################################################## 100.0%
==> Fetching openldap
==> Downloading https://ghcr.io/v2/homebrew/core/openldap/manifests/2.6.3
######################################################################## 100.0%
==> Downloading https://ghcr.io/v2/homebrew/core/openldap/blobs/sha256:db25c7e317ccf5ca1282b9ab4ef178f3bca979c0d6ace9b03161c97d1699f5f4
==> Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sha256:db25c7e317ccf5ca1282b9ab4ef178f3bca979c0d6ace9b03161c97d1699f5f4?se=2023-01-07T00%3A05%3A00Z&sig=Ekma8dkpcEvVlMOGUGC9m04Es6BrpRaXFOJ7%2BAG4gIk%3D&sp=r&spr=https&sr=b&sv=2019-12-12
######################################################################## 100.0%
==> Fetching pcre2
==> Downloading https://ghcr.io/v2/homebrew/core/pcre2/manifests/10.42
######################################################################## 100.0%
==> Downloading https://ghcr.io/v2/homebrew/core/pcre2/blobs/sha256:8423a338c590ab1a6f265b39a9d1a67ab1361a586f0e494a8c9555cff2867536
==> Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sha256:8423a338c590ab1a6f265b39a9d1a67ab1361a586f0e494a8c9555cff2867536?se=2023-01-07T00%3A05%3A00Z&sig=UH9jEW9scz%2B4VIEm9avNjMwpjj0ziVJosT9J0UzQVHU%3D&sp=r&spr=https&sr=b&sv=2019-12-12
######################################################################## 100.0%
==> Fetching lighttpd
==> Downloading https://ghcr.io/v2/homebrew/core/lighttpd/manifests/1.4.68
######################################################################## 100.0%
==> Downloading https://ghcr.io/v2/homebrew/core/lighttpd/blobs/sha256:1a30aefdaab4819bee28c3f63da0867f0031f825cd4dac522744b4d19162bc29
==> Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sha256:1a30aefdaab4819bee28c3f63da0867f0031f825cd4dac522744b4d19162bc29?se=2023-01-07T00%3A05%3A00Z&sig=W6MqyK7YOqYUpOqn4oqdZd%2BG6xaTn68LX5RcEp%2Ftuxc%3D&sp=r&spr=https&sr=b&sv=2019-12-12
######################################################################## 100.0%
==> Installing dependencies for lighttpd: openssl@1.1, openldap and pcre2
==> Installing lighttpd dependency: openssl@1.1
==> Pouring openssl@1.1--1.1.1s.arm64_ventura.bottle.tar.gz
🍺  /opt/homebrew/Cellar/openssl@1.1/1.1.1s: 8,101 files, 18MB
==> Installing lighttpd dependency: openldap
==> Pouring openldap--2.6.3.arm64_ventura.bottle.tar.gz
🍺  /opt/homebrew/Cellar/openldap/2.6.3: 83 files, 6.9MB
==> Installing lighttpd dependency: pcre2
==> Pouring pcre2--10.42.arm64_ventura.bottle.tar.gz
🍺  /opt/homebrew/Cellar/pcre2/10.42: 230 files, 6.2MB
==> Installing lighttpd
==> Pouring lighttpd--1.4.68.arm64_ventura.bottle.tar.gz
==> Caveats
Docroot is: /opt/homebrew/var/www

The default port has been set in /opt/homebrew/etc/lighttpd/lighttpd.conf to 8080 so that
lighttpd can run without sudo.

To restart lighttpd after an upgrade:
  brew services restart lighttpd
Or, if you don't want/need a background service you can just run:
  /opt/homebrew/opt/lighttpd/bin/lighttpd -D -f /opt/homebrew/etc/lighttpd/lighttpd.conf
==> Summary
🍺  /opt/homebrew/Cellar/lighttpd/1.4.68: 67 files, 2.8MB
==> Running `brew cleanup lighttpd`...
Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.
Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).
==> Upgrading 1 dependent of upgraded formulae:
Disable this behaviour by setting HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK.
Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).
git 2.38.1 -> 2.39.0
==> Fetching git
==> Downloading https://ghcr.io/v2/homebrew/core/git/manifests/2.39.0
######################################################################## 100.0%
==> Downloading https://ghcr.io/v2/homebrew/core/git/blobs/sha256:008095cdb07f1bbb0020249e3f3077322eaad0f16e3fc9bc2214cfa991cc58ed
==> Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sha256:008095cdb07f1bbb0020249e3f3077322eaad0f16e3fc9bc2214cfa991cc58ed?se=2023-01-07T00%3A05%3A00Z&sig=XHhYjysN7sQk75RlC4Y2C99D9s8PnsjoaDVj%2FF3dwFM%3D&sp=r&spr=https&sr=b&sv=2019-12-12
######################################################################## 100.0%
==> Upgrading git
  2.38.1 -> 2.39.0

==> Pouring git--2.39.0.arm64_ventura.bottle.tar.gz
==> Caveats
The Tcl/Tk GUIs (e.g. gitk, git-gui) are now in the `git-gui` formula.
Subversion interoperability (git-svn) is now in the `git-svn` formula.

zsh completions and functions have been installed to:
  /opt/homebrew/share/zsh/site-functions
==> Summary
🍺  /opt/homebrew/Cellar/git/2.39.0: 1,607 files, 48MB
==> Running `brew cleanup git`...
Removing: /opt/homebrew/Cellar/git/2.38.1... (1,592 files, 48.1MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/git--2.38.1... (17.2MB)
==> Checking for dependents of upgraded formulae...
==> No broken dependents found!
==> `brew cleanup` has not been run in the last 30 days, running now...
Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.
Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).
Removing: /Users/kalavatt/Library/Caches/Homebrew/file-formula--5.43... (42.7KB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/libcbor--0.9.0... (33.5KB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/libmagic--5.43... (1MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/libunistring--1.0... (1.6MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/ncurses--6.3... (2.3MB)
Removing: /opt/homebrew/Cellar/openssl@1.1/1.1.1q... (8,097 files, 18MB)
Removing: /opt/homebrew/Cellar/pcre2/10.40... (230 files, 6.1MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/pcre2--10.40... (2.0MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/python@3.10--3.10.8... (14.7MB)
Removing: /Users/kalavatt/Library/Caches/Homebrew/shellcheck--0.8.0... (13.8MB)
Removing: /Users/kalavatt/Library/Logs/Homebrew/shellcheck... (64B)
Pruned 0 symbolic links and 2 directories from /opt/homebrew
==> Caveats
==> lighttpd
Docroot is: /opt/homebrew/var/www

The default port has been set in /opt/homebrew/etc/lighttpd/lighttpd.conf to 8080 so that
lighttpd can run without sudo.

To restart lighttpd after an upgrade:
  brew services restart lighttpd
Or, if you don't want/need a background service you can just run:
  /opt/homebrew/opt/lighttpd/bin/lighttpd -D -f /opt/homebrew/etc/lighttpd/lighttpd.conf
==> git
The Tcl/Tk GUIs (e.g. gitk, git-gui) are now in the `git-gui` formula.
Subversion interoperability (git-svn) is now in the `git-svn` formula.

zsh completions and functions have been installed to:
  /opt/homebrew/share/zsh/site-functions
```
</details>
<br />

<a id="try-things-again-after-having-installed-lighttpd"></a>
#### Try things again after having installed `lighttpd`
```bash
#!/bin/bash
#DONTRUN #CONTINUE

docker run \
	--rm -it \
	--platform linux/amd64 \
    -v "/tmp":"/tmp" \
    -v "$(pwd)":"/$(basename "$(pwd)")" \
	-p "9000":"9000" \
  	pasapipeline/pasapipeline:latest \
  		/usr/local/src/PASApipeline/run_PasaWeb.pl 9000
```
Still encountering the error  

<a id="perform-troubleshooting"></a>
#### Perform troubleshooting
...following the advice [here (someone has filed an issue about it on the PASApipeline GitHub repo)](https://github.com/PASApipeline/PASApipeline/issues/251)
```bash
#!/bin/bash
#DONTRUN #CONTINUE

docker pull pasapipeline/pasapipeline:2.5.2-dev

docker run \
	--rm -it \
	--platform linux/amd64 \
    -v "/tmp":"/tmp" \
    -v "$(pwd)":"/$(basename "$(pwd)")" \
	-p "9000":"9000" \
  	pasapipeline/pasapipeline:2.5.2-dev \
  		/usr/local/src/PASApipeline/run_PasaWeb.pl 9000
```

<details>
<summary><i>Click to view: Messages printed to terminal</i></summary>

```txt
2.5.2-dev: Pulling from pasapipeline/pasapipeline
16ec32c2132b: Already exists
b7372f0e4c7e: Already exists
4b6435ab903e: Already exists
bb3ed4ec7a4c: Already exists
a43d589f1366: Already exists
aa307d929b17: Already exists
d3c331b9da8c: Already exists
39c12f722616: Already exists
97613b9eaeb3: Pull complete
6709031ebd7d: Pull complete
651ada37e8a6: Pull complete
00710f866793: Pull complete
cd5891bb7e20: Pull complete
Digest: sha256:55b93951b4f3f5c4abc822221ccd6e428b495c2f0ee4b5f90e844d02063adade
Status: Downloaded newer image for pasapipeline/pasapipeline:2.5.2-dev
docker.io/pasapipeline/pasapipeline:2.5.2-dev

❯ docker run \
>     --rm -it \
>     --platform linux/amd64 \
>     -v "/tmp":"/tmp" \
>     -v "$(pwd)":"/$(basename "$(pwd)")" \
>     -p "9000":"9000" \
>     pasapipeline/pasapipeline:2.5.2-dev \
>         /usr/local/src/PASApipeline/run_PasaWeb.pl 9000
/usr/sbin/lighttpd -D -f /usr/local/src/PASApipeline/PasaWeb.conf/lighttpd.conf.port9000
2023-01-06 19:08:05: (server.c.1488) server started (lighttpd/1.4.55)
```
</details>
<br />

<a id="using-a-web-browser-such-as-chrome-go-to-httplocalhost9000"></a>
##### Using a web browser such as `Chrome`, go to `http://localhost:9000/`

<a id="unable-to-connect-it-to-the-sqlite-database-so-try-changing-the-mounting"></a>
##### Unable to connect it to the `sqlite` database, so try changing the mounting
Input the below path to `PASAweb` (`localhost:9000`)
```bash
pwd
# /Users/kalavatt/projects-etc/2022_transcriptome-construction/results/2022-1201/trinity_5781-5782_Q_IP_merged.trim-rcor.multi-hit-mode_10_EndToEnd

docker run \
	--rm -it \
	--platform linux/amd64 \
    -v "/tmp":"/tmp" \
    -v "$(pwd)":"$(pwd)" \
	-p "9000":"9000" \
  	pasapipeline/pasapipeline:2.5.2-dev \
  		/usr/local/src/PASApipeline/run_PasaWeb.pl 9000
```
It works!

<a id="change-directories-to-check-another-sqlite-database"></a>
#### Change directories to check another `sqlite` database
Input the below path to `PASAweb` (`localhost:9000`)
```bash
cd ../trinity_5781-5782_Q_IP_merged.rcor.multi-hit-mode_100_Local/
pwd
# /Users/kalavatt/projects-etc/2022_transcriptome-construction/results/2022-1201/trinity_5781-5782_Q_IP_merged.rcor.multi-hit-mode_100_Local

#  Input the above string (without the hash) to PASAweb (localhost:9000)

docker run \
	--rm -it \
	--platform linux/amd64 \
    -v "/tmp":"/tmp" \
    -v "$(pwd)":"$(pwd)" \
	-p "9000":"9000" \
  	pasapipeline/pasapipeline:2.5.2-dev \
  		/usr/local/src/PASApipeline/run_PasaWeb.pl 9000
```
See additional details in [`AG_emails-notes.md`](./AG_emails-notes.md)
<br />
